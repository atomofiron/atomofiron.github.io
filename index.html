<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title></title>

<style type="text/css">
html, body, video {
	padding: 0px;
	margin: 0px;
	background-color: #000000;
	font-family: arial;
	overflow-x: hidden;
	user-select: none;
}
img {
	-webkit-user-drag: none;
}
::-webkit-scrollbar {
    display: none;
}
* {
	box-sizing: content-box;
}
video {
    filter: brightness(0.8) contrast(2) hue-rotate(300deg);
}
canvas {
	width: 100%;
	background-color: #000000;
    margin-bottom: -4px;
    image-rendering: optimizeSpeed;             /* Older versions of FF          */
    image-rendering: -moz-crisp-edges;          /* FF 6.0+                       */
    image-rendering: -webkit-optimize-contrast; /* Safari                        */
    image-rendering: -o-crisp-edges;            /* OS X & Windows Opera (12.02+) */
    image-rendering: pixelated;                 /* Awesome future-browsers       */
    -ms-interpolation-mode: nearest-neighbor;
}
#zero2 {
	visibility: hidden;
	text-align: center;
}
.layer {
	width: 440px;
	height: 411px;
	mix-blend-mode: exclusion;
}
.layer_box {
	top: 0;
	margin: auto;
}
#progress {
	height: 100px;
	position: absolute;
	left: 0;
	right: 0;
	top: 0;
	bottom: 0;
	margin: auto;
	color: #ff00ff;
	text-align: center;
	font-size: 48px;
}
#start_button {
	width: 200px;
	height: 200px;
	background-color: #ff00ff;
	border-radius: 999px;
	position: absolute;
	left: 0;
	right: 0;
	top: 0;
	bottom: 0;
	margin: auto;
	padding: 64px;
	padding-top: 32px;
	color: black;
	text-align: center;
	cursor: pointer;
	visibility: hidden;
}
#content {
	display: none;
}
#volume_box {
	width: 40px;
	height: 128px;
	border: 4px #550055 solid;
	border-radius: 999px;
	margin: 16px;
	overflow: hidden;
	background-color: #550055;
	z-index: 1;
}
#volume_track_line {
	width: 8px;
	height: 96px;
	background-color: #ff00ff;
	border-radius: 4px;
	position: absolute;
	left: 0;
	right: 0;
	top: 0;
	bottom: 0;
	margin: auto;
}
#volume_track {
	width: 100%;
	/*height: 80px; in html attribute*/
	position: absolute;
	background-color: #ff00ff;
	margin: 0 auto;
	bottom: 0;
	left: 0;
	right: 0;
	border-radius: 999px;
}
#volume_track img {
	width: 24px;
	height: 24px;
	position: absolute;
	left: 0;
	top: 8px;
	right: 0;
	margin: auto;
}
#header {
	height: 450px;
	position: relative;
	text-align: center;
}
.center_box {
	display: flex;
	justify-content: center;
	position: absolute;
	bottom: 0;
	left: 0;
	right: 0;
}
</style>
</head>
<body>

<div id="volume_box" style="position: absolute; right: 0">
	<div id="volume_track_line"></div>
	<div id="volume_track" style="height: 80px">
		<img id="volume_icon" src="./new/volume-off.png" />
	</div>
</div>
<div id="content">
	<div id="header">
		<div class="center_box">
			<div>
				<video id="zero2" width="800" autoplay="" loop="" playsmuted="" muted="" [muted]="'muted'">
				    <source src="./new/02-5.mp4" type="video/mp4">
				</video>
			</div>
		</div>
		<!-- <img id="avaRgb" style="transform: translate(400px, 0px);" class="layer" src="./new/me.png" width="440" /> -->
		<div class="center_box layer_box">
			<img id="avaRed" class="layer" src="./new/red.png" />
		</div>
		<div class="center_box layer_box">
			<img id="avaGreen" class="layer" src="./new/green.png" />
		</div>
		<div class="center_box layer_box">
			<img id="avaBlue" class="layer" src="./new/blue.png" />
		</div>

		<div class="center_box">
			<img src="./new/mnts.png" width="1000" height="206" />
		</div>
	</div>

	<!-- <audio src="cut.mp3" controls></audio> -->

	<canvas id="canvas_ground" style="width: 100%;"></canvas>
</div>

<div id="start_button">
	<img src="./new/yeah.png">
	<b>НАЖМИ НА МЕНЯ</b><br><br>
</div>
<div id="progress" style="visibility: visible;">0/4</div>

<script type="text/javascript">

const clog = console.log
function get(id) {
	return document.getElementById(id)
}

const px = 'px'
function noPx(value) {
	let str = value.endsWith(px) ? value.substring(0, value.length - 2) : value
	return (str.length == 0) ? 0 : parseInt(str)
}


const ground = document.getElementById("canvas_ground")
const ctx = ground.getContext("2d");

const pixelRatio = window.devicePixelRatio
const lineWidthMin = 1
const lineWidthMax = 5 * pixelRatio
const hLineCount = 100
let vLineCount = 30

const zeroTwo = get("zero2")

function updateLinesCount() {
	vLineCount = window.innerWidth * pixelRatio / 100
	vLineCount = vLineCount | 0
	vLineCount += vLineCount % 2
}
document.onresize = updateLinesCount
window.onresize = updateLinesCount

function drowVerticalLines(frameWidth, frameHeight) {
	ctx.lineCap = 'round'
	ctx.strokeStyle = "#ff00ff"

	const vOffset = 0
	const hStep = frameWidth / vLineCount

	const centerX = frameWidth / 2
	for (let x = hStep / 2; x < frameWidth - hStep / 4; x += hStep) {
		ctx.lineWidth = lineWidthMax * (1 - Math.abs(centerX - x) / centerX)
		ctx.beginPath()
		ctx.moveTo(x, 0)
		let dif = centerX - x
		dif *= Math.abs(dif) / hStep + 5
		ctx.lineTo(x - dif, frameHeight)
		ctx.stroke()
	}
}
let time = 0
function drowHorisontalLines() {
	const groundWidth = window.innerWidth * pixelRatio
	const groundHeight = window.innerHeight * pixelRatio

	ctx.lineWidth = lineWidthMax
    ctx.beginPath()
	ctx.moveTo(0, 0)
	ctx.lineTo(groundWidth, 0)
	ctx.stroke()

	for (let i = 0; i < hLineCount; i++) {
		let a = (i + 1) / hLineCount
		let y = Math.tan(time + (i + 1) * Math.PI / hLineCount) * 50 - 50
		y = y|0 + 0.5
		const lineWidth = lineWidthMax * (y / groundHeight) * pixelRatio
		ctx.lineWidth = Math.max(lineWidthMin, lineWidth)
	    ctx.beginPath()
		ctx.moveTo(0, y)
		ctx.lineTo(groundWidth, y)
		ctx.stroke()
	}
	time += Math.PI / 3000
	time %= Math.PI / 2
}
function drawGround() {
	const groundWidth = window.innerWidth * pixelRatio
	const groundHeight = window.innerHeight * pixelRatio

	ground.width = groundWidth
	ground.height = groundHeight

	drowVerticalLines(groundWidth, groundHeight)
	drowHorisontalLines()
}
setInterval(drawGround, 16)



const avaRed = get("avaRed")
const avaGreen = get("avaGreen")
const avaBlue = get("avaBlue")
const trembling = 5
let disappearance = 1 // 10
let maxTranslation = 20
let intensitySecuence = 0
let intensityStep = Math.PI / 30

let deviationRed = 0
let deviationGreen = 0
let deviationBlue = 0
let desortingInterval = 0
let oneWay = false
let disortingStarterInterval = 0
let probability = 0.5

function startDisorting(anyWay) {
	if (anyWay != true) {
		const yes = Math.random() < probability
		if (yes) probability /= 2
		else {
			probability += Math.min(0.3, (1 - probability) / 2)
			return
		}
	}
	clearInterval(desortingInterval)
	intensitySecuence = 0
	const deviation = Math.PI * 2 * Math.random()
	if (oneWay) {
		deviationRed = 0
		deviationGreen = 0
		deviationBlue = Math.PI
	} else {
		deviationRed = deviation
		deviationGreen = deviationRed + Math.PI * 2 / 3
		deviationBlue = deviationRed + Math.PI * 4 / 3
	}
	desortingInterval = setInterval(distortPicture, 16)
}
function distortPicture() {
	const r = oneWay ? Math.min(Math.PI / 2, intensitySecuence) : intensitySecuence
	intensitySecuence += intensityStep
	if (intensitySecuence > Math.PI) {
		intensitySecuence = 0
		clearInterval(desortingInterval)
		avaRed.style.transform = ''
		avaGreen.style.transform = ''
		avaBlue.style.transform = ''
		if (oneWay) {
			avaRed.style.display = 'none'
			avaGreen.style.display = 'none'
			avaBlue.style.display = 'none'
			zeroTwo.style.visibility = 'visible'
		}
		return
	}
	const intensity = Math.sin(r)
	distortLayer(avaRed, deviationRed, intensity, oneWay)
	distortLayer(avaGreen, deviationGreen, intensity)
	distortLayer(avaBlue, deviationBlue, intensity)
}
function distortLayer(element, radian, intensity, onlyTrembling) {
	const dx = intensity * disappearance * (Math.random() > 0.5) ? trembling : -trembling
	const dy = intensity * disappearance * (Math.random() > 0.5) ? trembling : -trembling
	const x = onlyTrembling ? dx : (Math.cos(radian) * maxTranslation * disappearance) * intensity + dx
	const y = onlyTrembling ? dy : (Math.sin(radian) * maxTranslation * disappearance) * intensity + dy
	element.style.transform = `translate(${x}px, ${y}px)`
}

function hidePicture() {
	clearInterval(disortingStarterInterval)
	oneWay = true
	disappearance = 10
	intensitySecuence = 0
	startDisorting(true)
}
function showPicture() {
	oneWay = false
	disappearance = 1
	avaRed.style.display = 'block'
	avaGreen.style.display = 'block'
	avaBlue.style.display = 'block'
	zeroTwo.style.visibility = 'hidden'
	clearInterval(disortingStarterInterval)
	disortingStarterInterval = setInterval(startDisorting, 900)
	startDisorting(true)
}


const volumeBox = get("volume_box")
const volumeTrack = get("volume_track")
const volumeIcon = get("volume_icon")
const startVolume = function() {
	volumeBox.onmousemove = moveVolume
}
const stopVolume = function() {
	volumeBox.onmousemove = null
}
volumeBox.onmousedown = startVolume
volumeBox.onmouseleave = stopVolume
volumeBox.onmouseup = stopVolume
volumeBox.onpointerdown = startVolume
volumeBox.onpointereave = stopVolume
volumeBox.onpointerup = stopVolume
let allowedType = null
const moveVolume = function(event) {
	if (allowedType == null) allowedType = event.type
	if (allowedType != event.type) return
	let height = noPx(volumeTrack.style.height) - event.movementY
	updadeVolumeOffset(height)
}
function updadeVolumeOffset(height) {
	const min = 40
	height = Math.max(min, height)
	height = Math.min(volumeBox.clientHeight, height)
	volumeTrack.style.height = height + px

	let volume = (height - min) / (volumeBox.clientHeight - min)
	audio.volume = volume
}
volumeBox.onclick = function(event) {
	if (event.pointerType == 'mouse') return
	const height = volumeBox.clientHeight - event.clientY + 40
	updadeVolumeOffset(height)
}

function onVolumeChanged(event) {
	updateVolumeIcon(audio.volume)
}

function updateVolumeIcon(volume) {
	if (volume == 0) volumeIcon.src = './new/volume-off.png'
	else if (volume < 1) volumeIcon.src = './new/volume-low.png'
	else volumeIcon.src = './new/volume-high.png'
}

const audio = new Audio("./new/cut.mp3")
audio.volume = 0.5
audio.onvolumechange = onVolumeChanged
updateVolumeIcon(audio.volume)
audio.onended = function() {
	audio.play()
}
audio.onplay = function() {
	showPicture()
	setTimeout(hidePicture, 48000)
	setTimeout(showPicture, 79000)
	setTimeout(hidePicture, 127000)
	setTimeout(showPicture, 143000)
}
const startButton = get("start_button")
startButton.onclick = function() {
	audio.play()
	startButton.style.display = 'none'
	get("content").style.display = 'block'
}

const progress = get("progress")
let count = 0
function onImageLoad(arg) {
	count++
	progress.innerText = `Loading… ${count}/4`
	if (count == 4) {
		progress.style.visibility = 'hidden'
		startButton.style.visibility = 'visible'
	}
}
const mnts = new Image()
const red = new Image()
const green = new Image()
const blue = new Image()
mnts.onload = onImageLoad
red.onload = onImageLoad
green.onload = onImageLoad
blue.onload = onImageLoad
mnts.src = "./new/mnts.png"
red.src = "./new/red.png"
green.src = "./new/green.png"
blue.src = "./new/blue.png"

</script>

</body>
</html>